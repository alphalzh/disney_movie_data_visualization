<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Disney Genres Scatter Plot with Legends on Right</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      overflow: hidden;
    }
    svg {
      display: block;
      margin: auto;
    }
    .axis path,
    .axis line {
      stroke: #aaa;
    }
    .axis text {
      font-size: 12px;
    }
    .legend {
      font-size: 12px;
      fill: #333;
    }
    .tooltip {
      pointer-events: none;
      font-size: 14px;
      fill: #000;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <svg id="chart"></svg>

  <script src="d3.v7.min.js"></script>
  <script>
  // CONFIG\  
  const margin = { top: 60, right: 200, bottom: 60, left: 80 };
  const width  = 800 - margin.left - margin.right;
  const height = 500 - margin.top  - margin.bottom;

  // SVG CANVAS
  const svg = d3.select("#chart")
    .attr("width",  width + margin.left + margin.right)
    .attr("height", height + margin.top  + margin.bottom)
    .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

  // LOAD & AGGREGATE
  d3.csv("disney_movies_total_gross.csv", d => ({
    genre: d.genre || "Unknown",
    gross: +d.inflation_adjusted_gross.replace(/[$,]/g, "")
  })).then(raw => {
    const rollup = d3.rollups(
      raw.filter(d => d.genre && !isNaN(d.gross)),
      v => {
        const total = d3.sum(v, d => d.gross);
        const count = v.length;
        return {
          count,
          totalGross:   total,
          averageGross: total / count
        };
      },
      d => d.genre
    );

    const data = rollup.map(([genre, stats]) => ({
      genre,
      count:        stats.count,
      totalGross:   stats.totalGross,
      averageGross: stats.averageGross
    }));

    // SCALES
    const x = d3.scaleLinear()
      .domain([0, d3.max(data, d => d.count) * 1.1])
      .range([0, width]);

    const y = d3.scaleLinear()
      .domain([0, d3.max(data, d => d.averageGross) * 1.1])
      .range([height, 0]);

    const maxGross = d3.max(data, d => d.totalGross);
    const color = d3.scaleSequential(d3.interpolateYlOrRd)
      .domain([0, maxGross]);

    const rScale = d3.scaleSqrt()
      .domain([0, maxGross])
      .range([4, 20]);

    // AXES
    svg.append("g")
      .attr("class","axis")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).ticks(8))
      .append("text")
        .attr("x", width/2)
        .attr("y", 40)
        .attr("fill","#000")
        .attr("text-anchor","middle")
        .text("Number of Movies");

    svg.append("g")
      .attr("class","axis")
      .call(d3.axisLeft(y).ticks(8)
        .tickFormat(d => "$" + d3.format(".2s")(d).replace("G","B"))
      )
      .append("text")
        .attr("transform","rotate(-90)")
        .attr("x",-height/2)
        .attr("y",-50)
        .attr("fill","#000")
        .attr("text-anchor","middle")
        .text("Average Inflation-Adjusted Gross");

    // PREPARE COLOR GRADIENT
    const defs = svg.append("defs");
    const gradient = defs.append("linearGradient")
      .attr("id","color-gradient")
      .attr("x1","0%").attr("y1","0%")
      .attr("x2","100%").attr("y2","0%");

    const stops = d3.range(0,1.01,0.1).map(t => ({
      offset: `${t*100}%`, color: color(t * maxGross)
    }));
    gradient.selectAll("stop")
      .data(stops)
      .enter().append("stop")
        .attr("offset", d => d.offset)
        .attr("stop-color", d => d.color);

    // DRAW & ANIMATE CIRCLES
    const circles = svg.selectAll(".point")
      .data(data, d => d.genre)
      .enter().append("circle")
        .attr("class","point")
        .attr("cx", d => x(d.count))
        .attr("cy", y(0))
        .attr("r", 0)
        .attr("fill", d => color(d.totalGross))
        .attr("stroke","#333")
        .attr("stroke-width",1)
      .on("mouseover", function(event,d) {
        d3.select(this)
          .transition().duration(200)
          .attr("r", rScale(d.totalGross) * 1.5);

        svg.selectAll(".tooltip").remove();
        svg.append("text")
          .attr("class","tooltip")
          .attr("x", x(d.count))
          .attr("y", y(d.averageGross) - (rScale(d.totalGross)*1.5) - 10)
          .attr("text-anchor","middle")
          .text(`${d.genre}: ${d3.format("$,.0f")(d.averageGross)} avg`);
      })
      .on("mouseout", function(event,d) {
        d3.select(this)
          .transition().duration(200)
          .attr("r", rScale(d.totalGross));

        svg.selectAll(".tooltip").remove();
      });

    circles.transition()
      .delay((d,i) => i * 100)
      .duration(1000)
      .attr("cy", d => y(d.averageGross))
      .attr("r", d => rScale(d.totalGross));

    // LEGENDS GROUPED ON RIGHT
    const legendX = width + 40;
    const lg = svg.append("g")
      .attr("transform", `translate(${legendX},0)`);

    // Colorbar legend
    const cbWidth  = 150;
    const cbHeight = 10;
    const cbScale  = d3.scaleLinear()
      .domain([0, maxGross])
      .range([0, cbWidth]);

    lg.append("text")
      .attr("class","legend")
      .attr("x", 0)
      .attr("y", 0)
      .text("Total Gross (color)");

    lg.append("rect")
      .attr("x", 0)
      .attr("y", 5)
      .attr("width", cbWidth)
      .attr("height", cbHeight)
      .style("fill", "url(#color-gradient)");

    lg.append("g")
      .attr("transform", `translate(0,${5 + cbHeight})`)
      .call(d3.axisBottom(cbScale)
        .ticks(5)
        .tickFormat(d => "$" + d3.format(".2s")(d).replace("G","B"))
      );

    // Size legend
    const sizeLegendY = 5 + cbHeight + 40;
    lg.append("text")
      .attr("class","legend")
      .attr("x", 0)
      .attr("y", sizeLegendY)
      .text("Total Gross (size)");

    const legendSizes = [ maxGross*0.1, maxGross*0.5, maxGross ];
    const sl = lg.append("g")
      .attr("transform", `translate(0,${sizeLegendY + 30})`); // moved down

    sl.selectAll("circle")
      .data(legendSizes)
      .enter().append("circle")
        .attr("cx", (d,i) => i * 60 + rScale(d))
        .attr("cy", 0)
        .attr("r", d => rScale(d))
        .attr("fill", d => color(d)) // filled with color
        .attr("stroke","#333");

    sl.selectAll("text.size-label")
      .data(legendSizes)
      .enter().append("text")
        .attr("class","legend size-label")
        .attr("x", (d,i) => i * 60 + rScale(d))
        .attr("y", d => rScale(d) + 15)
        .attr("text-anchor","middle")
        .text(d => "$" + d3.format(".2s")(d).replace("G","B"));

  }).catch(err => console.error(err));
  </script>
</body>
</html>
