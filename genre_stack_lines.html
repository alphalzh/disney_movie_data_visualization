<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Disney Gross by Top 3 Genres + Others</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      overflow: hidden;
    }
    svg {
      display: block;
      margin: auto;
    }
    .area {
      stroke: #333;
      stroke-width: 0.5px;
      fill-opacity: 0.8;
    }
    .axis path,
    .axis line {
      stroke: #aaa;
    }
    .axis text {
      font-size: 12px;
    }
    .legend {
      font-size: 12px;
    }
  </style>
</head>
<body>
  <svg id="chart"></svg>

  <script src="d3.v7.min.js"></script>
  <script>
  const margin = { top: 40, right: 150, bottom: 40, left: 60 };
  const width  = 960 - margin.left - margin.right;
  const height = 500 - margin.top - margin.bottom;

  const svg = d3.select("#chart")
    .attr("width",  width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

  // Clip‐path for reveal animation
  svg.append("defs")
    .append("clipPath")
      .attr("id", "reveal-clip")
    .append("rect")
      .attr("width", 0)
      .attr("height", height);

  d3.csv("disney_movies_total_gross.csv", d => ({
    year:  new Date(d.release_date).getFullYear(),
    genre: d.genre || "Unknown",
    gross: +d.inflation_adjusted_gross.replace(/[$,]/g, "")
  })).then(raw => {
    // 1. Filter out bad rows
    const data = raw.filter(d =>
      !isNaN(d.year) &&
      d.genre &&
      !isNaN(d.gross)
    );

    // 2. Compute total gross per genre, sort and pick top 3
    const genreTotals = d3.rollups(
      data,
      v => d3.sum(v, d => d.gross),
      d => d.genre
    ).sort((a,b) => b[1] - a[1]);

    const topGenres = genreTotals.slice(0,3).map(d => d[0]);
    const allSeries  = [...topGenres, "Others"];

    // 3. Roll up by year & genre
    const yearGenreRollup = d3.rollups(
      data,
      v => d3.sum(v, d => d.gross),
      d => d.year,
      d => d.genre
    );
    const yearMap = new Map(
      yearGenreRollup.map(([year, arr]) =>
        [year, new Map(arr)]
      )
    );

    // 4. Build per‐year table with only top 3 + Others
    const years = Array.from(yearMap.keys()).sort((a,b) => a - b);
    const table = years.map(year => {
      const byGen = yearMap.get(year);
      // sum of all other genres
      const sumOthers = d3.sum(
        Array.from(byGen.entries())
          .filter(([g]) => !topGenres.includes(g))
          .map(([,v]) => v)
      );
      const row = { year: new Date(year,0,1) };
      topGenres.forEach(g => {
        row[g] = byGen.get(g) || 0;
      });
      row["Others"] = sumOthers;
      return row;
    });

    // 5. Stack layout
    const stack = d3.stack()
      .keys(allSeries)
      .order(d3.stackOrderNone)
      .offset(d3.stackOffsetNone);

    const series = stack(table);

    // 6. Scales & axes
    const x = d3.scaleTime()
      .domain(d3.extent(table, d => d.year))
      .range([0, width]);

    const y = d3.scaleLinear()
      .domain([0, d3.max(series, s => d3.max(s, d => d[1]))])
      .nice()
      .range([height, 0]);

    const color = d3.scaleOrdinal()
      .domain(allSeries)
      .range(d3.schemeTableau10);

    svg.append("g")
      .attr("class", "axis")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).ticks(10).tickFormat(d3.timeFormat("%Y")));

    svg.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y)
        .ticks(6)
        .tickFormat(d => "$" + d3.format(".2s")(d).replace("G","B"))
      );

    // 7. Draw areas (clipped)
    const area = d3.area()
      .x(d => x(d.data.year))
      .y0(d => y(d[0]))
      .y1(d => y(d[1]));

    svg.append("g")
      .attr("clip-path", "url(#reveal-clip)")
      .selectAll(".layer")
      .data(series)
      .join("path")
        .attr("class", "area")
        .attr("fill", d => color(d.key))
        .attr("d", area);

    // 8. Legend
    const legend = svg.append("g")
      .attr("transform", `translate(${width + 20},0)`);

    allSeries.forEach((g,i) => {
      const row = legend.append("g")
        .attr("transform", `translate(0,${i*20})`);
      row.append("rect")
        .attr("width", 15)
        .attr("height", 15)
        .attr("fill", color(g));
      row.append("text")
        .attr("x", 20)
        .attr("y", 12)
        .attr("class", "legend")
        .text(g);
    });

    // 9. Animate reveal
    svg.select("#reveal-clip rect")
      .transition()
      .duration(6000)
      .attr("width", width);

  }).catch(err => console.error(err));
  </script>
</body>
</html>
